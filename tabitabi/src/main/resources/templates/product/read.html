<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>상품 상세조회</title>
    <script>
        function removeFile() {
            document.getElementById("fileRemoved").value = "true";
            document.getElementById("productImage").style.display = "none";
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        img{
        	width:20%;
        	margin:auto;
        	display:block;
        }
        .product-details {
            margin-top: 20px;
        }
        .product-details td {
            padding: 10px;
        }
     	.heartIcon{
     		width:2%;
     		height:2%;
     	}
     	
		#toast_message {
		    opacity: 0;
		    position: fixed;
		    top: -100px;
		    left: 50%;
		    transform: translate(-50%,0);
		    padding: 10px 50px;
		    background: rgba(0, 0, 0, 0.70);
		    border-radius: 100px;
		    color: #fff;
		    box-shadow: 3px 4px 11px 0px #00000040;
		    transition: all 0.5s;
		}
		#toast_message.active {
		    opacity: 1;
		    top: 50px;
		}
      
    </style>
</head>
<body>
    <div class="product-detail-container">
    	<input id="move-cart-page" class="move-cart-page" type="button"
		value="장바구니 보기" />
    	<!-- 토스트 메시지 -->
        <div id="toast_message"></div>
        <!-- 상품 이미지 -->
        <div class="product-image-container" style="text-align: center;">
            <img th:if="${productImage != null}" 
                  th:src="@{/products/files?filename={filename}(filename=${productImage.saved_filename})}"
                 alt="Product Image"/>
        </div>
        <div class="add-cart-button-container">
        	<input id="add-cart-button" class="add-cart-button" type="button" value="장바구니에 추가하기" />
        </div>
        <p>
        
        <!-- 상품 정보 -->
        <div class="product-details">
            <table border="1" width="100%">
                <tr>
                    <td><strong>상품명:</strong> <span th:text="${product.name}"></span></td>
                </tr>
                <tr>
                    <td><strong>상품 설명:</strong> <span th:text="${product.description}"></span></td>
                </tr>
                <tr>
                    <td><strong>가격:</strong>
                        <th:block th:if="${product.price != 0}">
                            <span th:text="|${#numbers.formatInteger(product.price, 0, 'COMMA')}원|"></span>
                        </th:block>
                        <th:block th:if="${product.price == 0}">
                            <span>가격 정보 없음</span>
                        </th:block>
                    </td>
                </tr>
                <tr>
                    <td><strong>카테고리:</strong> <span th:text="${product.category}"></span></td>
                </tr>
            </table>
        </div>
    </div>
    <input type="button" onclick="location.href='/'" value="메인으로">
   	<input type="button" onclick="location.href='http://localhost:9000/products/list'" value="상품리스트 보기">

<script th:inline="javascript">
window.onload = function (){
	
	const showTM = (message) => {
		const tm = document.querySelector('#toast_message'); // 토스트 메시지 요소 가져오기
		tm.textContent = message; // 메시지값 주기
		tm.classList.add('active'); // 클래스 속성에 'active' 추가
		setTimeout(() => tm.classList.remove('active'), 2000) // 클래스 속성에서 'active' 제거(1000밀리초 후)
	}
	
    // 장바구니에 추가하기하는 함수
    const addCart = async () => {
    	let productId = [[${product.productId}]];
    	console.log('상품 정보:', productId);
    	return await fetch("http://localhost:9000/cart", {
    		method: "POST",
    		headers: {
    			"Content-Type" : "application/json",
    		},
    		body: JSON.stringify({productId})
    	})
    	.then((response)=>{
    		if(response.ok) return response.json();
    		else {
    	        return response.json().then(error => {
    	            throw new Error(error.message);
    	        });
    	    }
    	})
    	.then(data => {
    		console.log("장바구니 추가 성공");
    		console.log(data.message);
    		showTM(data.message);
    	})
    	.catch(error => {
    		console.log("장바구니 추가 실패");
    		console.log(error.message);
    		showTM(error.message);
    	})
    }

    // 요소에 이벤트 바인딩하기
    document.querySelector('#add-cart-button').addEventListener('click', addCart);
    
    document.querySelector('#move-cart-page').addEventListener('click', () => {
        let member_id = /*[[${member != null} ? ${member.id} : 0]]*/ 0;
        if (member_id !== 0) {
            window.location.href = `http://localhost:9000/cart/${member_id}`;
        } else {
            window.location.href = `http://localhost:9000/member/login`;
        }
    });
}
</script>
</body>
</html>
